
@startuml
skinparam ParticipantPadding 10
skinparam BoxPadding 10

box "A crate Offer"
actor JitsiConference #red
participant JingleSessionPC<<(C,#ADD1B2)>>
participant RTC1 <<(C,#ADD1B2)>>
participant TraceableUnifiedPlanPeerConnection<<(C,#ADD1B2)>>
participant XmPP
end box
actor Participant

== Initialization ==
note right of JingleSessionPC
 Like in Offer


end note

== Create Answer ==
note right of JitsiConference
JitsiConference::onCallAccepted
end note

JitsiConference -> JingleSessionPC:  setAnswer
JingleSessionPC -> JingleSessionPC:  setOfferAnswerCycle
activate JingleSessionPC
    JingleSessionPC ->  TraceableUnifiedPlanPeerConnection:  addTrack(LocalTrack's)
    note right of JingleSessionPC
     Prepare and set the new Remote SDP, perhaps change this!!!!!!
    end note
    JingleSessionPC -> JingleSessionPC :_processNewJingleOfferIq()
    JingleSessionPC -> JingleSessionPC :_renegotiate()
    activate JingleSessionPC #FFBBBB
        JingleSessionPC -> JingleSessionPC :_responderRenegotiate()
        activate JingleSessionPC #DarkSalmon
            JingleSessionPC -> TraceableUnifiedPlanPeerConnection: setRemoteDescription(<RTCSessionDescription>answer)
            note right of TraceableUnifiedPlanPeerConnection
             normalise SDP
            end note
                activate TraceableUnifiedPlanPeerConnection #FFBBBB
                    TraceableUnifiedPlanPeerConnection -> TraceableUnifiedPlanPeerConnection:_injectH264IfNotPresent
                    note right of TraceableUnifiedPlanPeerConnection
                     Safari changes in h264 video mline
                    end note
                deactivate TraceableUnifiedPlanPeerConnection

                JingleSessionPC -> TraceableUnifiedPlanPeerConnection: createAnswer
                note right of TraceableUnifiedPlanPeerConnection
                    Special behavior of Firefox video getSenders
                end note
                activate TraceableUnifiedPlanPeerConnection
                                TraceableUnifiedPlanPeerConnection -> TraceableUnifiedPlanPeerConnection: _createOfferOrAnswer()
                                    activate TraceableUnifiedPlanPeerConnection #FFBBBB
                                    note right of TraceableUnifiedPlanPeerConnection
                                     extractSSRCMap ---> this.localSSRCs: TPCSSRCInfo
                                    end note
                                    TraceableUnifiedPlanPeerConnection -> TraceableUnifiedPlanPeerConnection: extractSSRCMap
                                    TraceableUnifiedPlanPeerConnection -> TraceableUnifiedPlanPeerConnection: _processLocalSSRCsMap()
                                        activate TraceableUnifiedPlanPeerConnection #DarkSalmon
                                            TraceableUnifiedPlanPeerConnection -> TraceableUnifiedPlanPeerConnection: this.localSSRCs.set(track.rtcId, newSSRC);
                                            TraceableUnifiedPlanPeerConnection --> JingleSessionPC: Promis<RTCSessionDescription>
                                        deactivate TraceableUnifiedPlanPeerConnection
                                    deactivate TraceableUnifiedPlanPeerConnection
                                deactivate TraceableUnifiedPlanPeerConnection
            deactivate JingleSessionPC
        deactivate JingleSessionPC

        JingleSessionPC -> JingleSessionPC: notifyMySSRCUpdate
        activate JingleSessionPC #FFBBBB
            JingleSessionPC -> XmPP: sendIQ: source-add | source-remove
            XmPP -> Participant
        deactivate JingleSessionPC
     deactivate JingleSessionPC

deactivate JingleSessionPC

JitsiConference -> JingleSessionPC : sendSessionAccept
JingleSessionPC -> XmPP: sendIQ: session-accept -> initiator
XmPP -> Participant
@enduml
